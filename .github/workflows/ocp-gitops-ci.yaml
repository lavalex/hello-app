name: Build and Deploy to OpenShift

on:
  push:
    branches: [ "main" ]
    paths:
      - "app.js"
      - "Dockerfile"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Buildah
      run: |
        sudo apt-get update
        sudo apt-get -y install buildah

    - name: Login to Quay
      run: |
        buildah login ${{ vars.REGISTRY_URL }} \
          -u "${{ secrets.REGISTRY_USERNAME }}" \
          -p "${{ secrets.REGISTRY_PASSWORD }}"

    - name: Set image tag
      run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    - name: Build image
      run: |
        buildah bud -t "${{ vars.REGISTRY_URL }}/${{ vars.REGISTRY_REPO }}:${IMAGE_TAG}" .

    - name: Push image
      run: |
        buildah push "${{ vars.REGISTRY_URL }}/${{ vars.REGISTRY_REPO }}:${IMAGE_TAG}"

    - name: Checkout GitOps repo
      uses: actions/checkout@v4
      with:
        repository: ${{ vars.GITOPS_REPO }}
        ssh-key: ${{ secrets.GITOPS_SSH_KEY }}
        path: gitops

    - name: Update deployment image tag
      run: |
        sed -i "s|image:.*|image: ${{ vars.REGISTRY_URL }}/${{ vars.REGISTRY_REPO }}:${IMAGE_TAG}|g" gitops/deployment.yaml

    - name: Commit and push changes
      working-directory: gitops
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Deploy ${IMAGE_TAG}"
        git push

